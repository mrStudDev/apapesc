{% extends "base.html" %}
{% load static %}

{% block title %}Controle Guias INSS{% endblock title %}

{% load custom_filters %}

{% block emissao_inss %}

    {% include "components/navbar_associacao.html" %}

    {% if messages %}
    <div class="mb-4">
        {% for message in messages %}
            <div class="p-4 rounded-md text-white 
                {% if message.tags == 'success' %}
                    bg-green-500
                {% elif message.tags == 'error' %}
                    bg-red-500
                {% elif message.tags == 'info' %}
                    bg-blue-500
                {% else %}
                    bg-gray-500
                {% endif %}
            ">
                {{ message }}
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <main class="flex-grow">
        <div class="container mx-auto mt-8">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-8">Controle de EmissÃ£o de Guias INSS</h1>
    
        <!-- Filtros -->
        <form method="get" class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Filtro por Nome -->
            <div>
                <label for="busca" class="block text-lg font-semibold text-gray-700 mb-1">Buscar Associado:</label>
                <div class="relative">
                    <input type="text" name="busca" id="busca" value="{{ request.GET.busca }}"
                           class="w-full border border-gray-300 rounded-md py-2 pl-3 pr-10 h-12 text-lg"
                           placeholder="Digite o nome...">
                    <button type="submit" class="absolute right-2 top-2 text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Filtro de Ano -->
            <div>
                <label for="ano" class="block text-lg font-semibold text-gray-700 mb-1">Selecione o Ano:</label>
                <select name="ano" id="ano"
                        class="w-full border border-gray-300 rounded-md py-2 pl-3 pr-10 h-12 text-lg">
                    {% for ano in anos_disponiveis %}
                    <option value="{{ ano }}" {% if ano == ano_selecionado %}selected{% endif %}>{{ ano }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- BotÃ£o Filtrar -->
            <div class="flex items-end">
                <button type="submit"
                        class="w-full md:w-auto bg-blue-500 text-white font-medium py-2 px-6 rounded hover:bg-blue-600 h-12">
                    Aplicar Filtros
                </button>
            </div>
        </form>
    
            <!-- Tabela -->
            <div class="overflow-x-auto shadow-md rounded-lg">
                <table class="min-w-full border border-gray-300 rounded-md overflow-hidden">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-left font-semibold text-gray-700">Associado</th>
                            {% for mes in meses_validos %}
                            <th class="px-6 py-3 text-center font-semibold text-gray-700">{{ mes }}/{{ ano_selecionado }}</th>
                            {% endfor %}
                        </tr>
                    </thead>

                    <tbody>
                        {% for associado_id, associado_info in guias_por_associado.items %}
                        <tr class="hover:bg-gray-50 border-b">
                            <!-- Nome do Associado -->
                            <td class="px-6 py-4 text-gray-800 font-medium whitespace-nowrap text-sm">
                                {{ associado_info.dados.user__first_name }} {{ associado_info.dados.user__last_name }}
                            </td>
                      
                            <!-- Iterando pelos meses -->
                            {% for mes in meses_validos %}
                            <td class="px-4 py-3 text-center align-top text-xs" id="guia-{{ associado_id }}-{{ mes }}">
                              {% with guia=associado_info.guias|dict_key:mes %}
                              {% if guia %}
                                <!-- Estado: Pendente (Etapa 1) -->
                                {% if guia.status == "pendente" %}
                                  <div class="guia-pendente">
                                      <div class="dados-associado mt-2 space-y-1 bg-yellow-50 p-2 rounded-md shadow-inner text-left">
                                        <!-- CPF -->
                                        <div class="flex justify-between items-center">
                                            <span id="cpf-{{ associado_id }}" class="text-gray-800 font-mono text-[11px]">{{ associado_info.dados.cpf }}</span>
                                            <button type="button" data-copy-target="cpf-{{ associado_id }}" 
                                                class="btn-copiar text-blue-600 hover:text-blue-800 text-xs focus:outline-none">ðŸ“‹</button>
                                        </div>
                                      
                                        <!-- Senha Gov -->
                                        <div class="flex justify-between items-center">
                                            <span id="senha-{{ associado_id }}" class="text-gray-800 font-mono text-[11px]">{{ associado_info.dados.senha_gov }}</span>
                                            <button type="button" data-copy-target="senha-{{ associado_id }}" 
                                                  class="btn-copiar text-blue-600 hover:text-blue-800 text-xs focus:outline-none">ðŸ“‹</button>
                                        </div>
                                        <!-- Associado Nome -->
                                        <div class="flex justify-between items-center">
                                            <span id="nome-{{ associado_info.dados.id }}" class="text-gray-800 font-mono text-[11px]">
                                                {{ associado_info.dados.user__first_name }}
                                            </span>
                                            <button type="button" data-copy-target="nome-{{ associado_info.dados.id }}" 
                                                    class="btn-copiar text-blue-600 hover:text-blue-800 text-xs focus:outline-none">ðŸ“‹</button>
                                        </div>                                       
                                      </div>
                            
                                      <div class="mt-2 space-y-1">
                                        <!-- BotÃ£o Continuar -->
                                        <form method="post" class="form-avancar-status" 
                                              action="{% url 'app_tarefas:atualizar_status_guia' guia.id %}">
                                          {% csrf_token %}
                                          <button type="submit" 
                                                  class="w-full bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded shadow transition">
                                            Confirmar EmissÃ£o (Etapa 1)
                                          </button>
                                        </form>
                                        
                                        <!-- BotÃ£o Reiniciar -->
                                        <form method="post" class="form-reiniciar-guia"
                                              action="{% url 'app_tarefas:zerar_status_guia' guia.id %}">
                                          {% csrf_token %}
                                          <button type="submit" 
                                                  class="w-full text-xs text-red-500 hover:text-red-700 underline">
                                            ðŸ”„ Reiniciar Processo
                                          </button>
                                        </form>
                                      </div>
                                  </div> 

                                  {% elif guia.status == "emitido" %}
                                  <div class="guia-emitida">
                                      <div class="dados-celular mt-2 bg-green-50 p-2 rounded-md shadow-inner text-left">
                                          <div class="flex justify-between items-center">
                                              <span id="celular-{{ associado_id }}" class="text-gray-800 font-mono text-[11px]">{{ associado_info.dados.celular_correspondencia }}</span>
                                              <button type="button" data-copy-target="celular-{{ associado_id }}" 
                                                      class="btn-copiar text-blue-600 hover:text-blue-800 text-xs focus:outline-none">ðŸ“‹</button>
                                          </div>
                                      </div>
                                  
                                      <div class="mt-2 space-y-1">
                                          <!-- BotÃ£o Continuar -->
                                          <form method="post" class="form-avancar-status" 
                                                action="{% url 'app_tarefas:atualizar_status_guia' guia.id %}">
                                              {% csrf_token %}
                                              <div class="relative inline-block w-full">
                                                <button type="submit" 
                                                        class="w-full bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded shadow transition relative overflow-visible">
                                                    Confirmar Envio (Etapa 12)
                                                    <span class="absolute -top-1 -right-1 h-3 w-3 rounded-full bg-red-500 border-2 border-white shadow-sm animate-pulse"></span>
                                                </button>
                                            </div>
                                          </form>
                                          
                                          <!-- BotÃ£o Reiniciar -->
                                          <form method="post" class="form-reiniciar-guia"
                                                action="{% url 'app_tarefas:zerar_status_guia' guia.id %}">
                                              {% csrf_token %}
                                              <button type="submit" 
                                                      class="w-full text-xs text-red-500 hover:text-red-700 underline">
                                                  ðŸ”„ Reiniciar Processo
                                              </button>
                                          </form>
                                      </div>
                                  </div>                                  

                                <!-- Estado:Enviado Confirmar pgto (Etapa 3) -->
                                {% elif guia.status == "enviado" %}
                                <div class="guia-enviada">
                                  <p class="text-green-600 text-xs mb-2">Marcado como enviada!</p>
                                  
                                  <div class="space-y-1">
                                    <!-- BotÃ£o Continuar -->
                                    <form method="post" class="form-avancar-status" 
                                          action="{% url 'app_tarefas:atualizar_status_guia' guia.id %}">
                                      {% csrf_token %}
                                      <button type="submit" 
                                        class="w-full bg-orange-500 hover:bg-orange-600 text-white text-xs px-3 py-1 rounded shadow transition relative">
                                        Confirmar Pgto??? (Final)
                                        <span class="absolute top-0 right-0 -mt-1 -mr-1 flex h-3 w-3">
                                            <span class="absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span>
                                            <span class="relative inline-flex rounded-full h-3 w-3 bg-yellow-300"></span>
                                        </span>
                                      </button>
                                    </form>
                                    
                                    <!-- BotÃ£o Reiniciar -->
                                    <form method="post" class="form-reiniciar-guia"
                                          action="{% url 'app_tarefas:zerar_status_guia' guia.id %}">
                                      {% csrf_token %}
                                      <button type="submit" 
                                              class="w-full text-xs text-red-500 hover:text-red-700 underline">
                                        ðŸ”„ Reiniciar Processo
                                      </button>
                                    </form>
                                  </div>
                                </div>
                            
                                <!-- Estado: Pago (Processo Finalizado) Etapa - 4-->
                                {% elif guia.status == "pago" %}
                                <div class="guia-paga">
                                    <div class="flex items-center justify-center">
                                        <span class="inline-flex items-center bg-green-50 text-green-700 px-3 py-1 rounded-full text-xs font-semibold shadow-sm ring-1 ring-green-100">
                                          <span class="flex-shrink-0 w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                                          âœ… Guia Paga!
                                        </span>
                                      </div>
                                  
                                  <!-- BotÃ£o Reiniciar -->
                                  <form method="post" class="form-reiniciar-guia mt-2 text-center"
                                        action="{% url 'app_tarefas:zerar_status_guia' guia.id %}">
                                    {% csrf_token %}
                                    <button type="submit" 
                                            class="text-xs text-red-500 hover:text-red-700 underline">
                                      ðŸ”„ Reiniciar Processo
                                    </button>
                                  </form>
                                </div>
                                {% endif %}
                            
                              {% else %}
                                <!-- Estado: Sem Guia (Iniciar Processo) -->
                                <div class="sem-guia">
                                  <form method="post" class="form-criar-guia" 
                                        action="{% url 'app_tarefas:criar_guia' associado_id mes ano_selecionado %}">
                                    {% csrf_token %}
                                    <button type="submit" 
                                        class="w-full bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded shadow transition relative">
                                        Iniciar Processo
                                        <span class="absolute top-0 right-0 -mt-1 -mr-1 flex h-3 w-3">
                                            <span class="absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                            <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                                        </span>
                                    </button>
                                  </form>
                                </div>
                              {% endif %}
                            {% endwith %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>                                     
                </table>
            </div>
        </div>
    </main>
    
    
    {% include "components/footer_associacao.html" %}

    <script>
      // ConfiguraÃ§Ã£o inicial quando o DOM estiver pronto
      document.addEventListener('DOMContentLoaded', function() {
          // Configura todos os event listeners
          setupEventListeners();
          
          // Define a funÃ§Ã£o global de copiar para clipboard
          window.copyToClipboard = copyToClipboard;
      });
      
      /**
       * Configura todos os event listeners necessÃ¡rios
       */
      function setupEventListeners() {
          // DelegaÃ§Ã£o de eventos para formulÃ¡rios
          document.body.addEventListener('submit', function(e) {
              // FormulÃ¡rios de avanÃ§ar status ou criar guia
              if (e.target.classList.contains('form-avancar-status') || 
                  e.target.classList.contains('form-criar-guia')) {
                  e.preventDefault();
                  handleFormSubmit(e.target);
              }
              
              // FormulÃ¡rios de reiniciar guia
              if (e.target.classList.contains('form-reiniciar-guia')) {
                  e.preventDefault();
                  if(confirm('Deseja realmente reiniciar este processo?')) {
                      handleFormSubmit(e.target, true);
                  }
              }
          });
          
          // DelegaÃ§Ã£o de eventos para botÃµes de cÃ³pia
          document.body.addEventListener('click', function(e) {
              if (e.target.classList.contains('btn-copiar')) {
                  handleCopyClick(e);
              }
          });
      }
      
      /**
       * Manipula o clique em botÃµes de cÃ³pia
       */
      function handleCopyClick(event) {
          event.preventDefault();
          event.stopPropagation();
          
          const target = event.target.getAttribute('data-copy-target');
          copyToClipboard(target).then(success => {
              if (success) {
                  showCopyFeedback(event.target);
              }
          });
      }
      
      /**
       * Mostra feedback visual quando o texto Ã© copiado
       */
      function showCopyFeedback(button) {
          const originalText = button.innerHTML;
          button.innerHTML = 'âœ“ Copiado!';
          setTimeout(() => {
              button.innerHTML = originalText;
          }, 2000);
      }
      
      /**
       * FunÃ§Ã£o para copiar texto para o clipboard
       */
      function copyToClipboard(elementId) {
          const element = document.getElementById(elementId);
          if (!element) {
              console.error('Elemento nÃ£o encontrado:', elementId);
              return Promise.resolve(false);
          }
          
          const textToCopy = element.textContent.trim();
          return navigator.clipboard.writeText(textToCopy)
              .then(() => true)
              .catch(err => {
                  console.error('Erro ao copiar:', err);
                  return false;
              });
      }
      
      /**
       * Manipula o envio de formulÃ¡rios via AJAX
       */
      function handleFormSubmit(form, isReload = false) {
          const cell = form.closest('td');
          const button = form.querySelector('button[type="submit"]');
          const originalText = button?.textContent;
          
          // Mostrar estado de carregamento
          if (button) {
              button.disabled = true;
              button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
          }
          
          fetch(form.action, {
              method: 'POST',
              body: new FormData(form),
              headers: {
                  'X-CSRFToken': getCSRFToken(),
                  'Accept': 'application/json',
                  'X-Requested-With': 'XMLHttpRequest'
              }
          })
          .then(response => {
              if (!response.ok) {
                  return response.json().then(err => {
                      throw new Error(err.message || 'Erro na requisiÃ§Ã£o');
                  });
              }
              return response.json();
          })
          .then(data => {
              if (data.success) {
                  // Recarrega a pÃ¡gina se for reiniciar ou se solicitado
                  if (isReload || data.reload) {
                      window.location.reload();
                  } 
                  // Atualiza apenas a cÃ©lula se houver HTML retornado
                  else if (data.html) {
                      cell.innerHTML = data.html;
                      setupEventListeners(); // Reconecta os eventos
                  }
                  
                  if (data.message) {
                      showMessage(data.message, 'success');
                  }
              } else {
                  throw new Error(data.message || 'Erro na operaÃ§Ã£o');
              }
          })
          .catch(error => {
              console.error('Erro:', error);
              showMessage(error.message, 'error');
              
              // Restaurar botÃ£o se existir
              if (button) {
                  button.disabled = false;
                  button.textContent = originalText;
              }
          });
      }
      
      /**
       * ObtÃ©m o token CSRF do formulÃ¡rio
       */
      function getCSRFToken() {
          const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
          return csrfInput ? csrfInput.value : '';
      }
      
      /**
       * Mostra mensagens flutuantes para o usuÃ¡rio
       */
      function showMessage(text, type = 'info') {
          // Remove mensagens antigas
          document.querySelectorAll('.mensagem-flutuante').forEach(msg => msg.remove());
          
          const typeClasses = {
              'success': 'bg-green-500 text-white',
              'error': 'bg-red-500 text-white',
              'info': 'bg-blue-500 text-white'
          };
          
          const messageDiv = document.createElement('div');
          messageDiv.className = `mensagem-flutuante fixed top-4 right-4 p-4 rounded-md shadow-lg ${typeClasses[type] || typeClasses.info} z-50`;
          messageDiv.innerHTML = `<div class="flex items-center"><span>${text}</span></div>`;
          
          document.body.appendChild(messageDiv);
          
          // Remove a mensagem apÃ³s 3 segundos
          setTimeout(() => {
              messageDiv.classList.add('opacity-0', 'transition-opacity', 'duration-300');
              setTimeout(() => messageDiv.remove(), 300);
          }, 3000);
      }
      </script>
          
{% endblock emissao_inss %}