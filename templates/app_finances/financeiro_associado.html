{% extends 'base.html' %}
{% load static %}
{% block title %}Finceiro {{ associado.user.get_full_name }}{% endblock title %}

{% block financeiro_SingleAssociado %}
    <!-- Navbar -->
    {% include "components/navbar_associacao.html" %}

    <main class="flex-grow">
        <div class="container mx-auto px-6 py-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Situa√ß√£o Financeira do Associado</h1>
            {% if messages %}
            <div class="mb-4">
                {% for message in messages %}
                    <div class="p-4 rounded-md text-white 
                        {% if message.tags == 'success' %}
                            bg-green-500
                        {% elif message.tags == 'error' %}
                            bg-red-500
                        {% elif message.tags == 'info' %}
                            bg-blue-500
                        {% else %}
                            bg-gray-500
                        {% endif %}
                    ">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
            {% endif %}
            <!-- üîπ Informa√ß√µes do Associado -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-6 border-l-4 border-gray-800">
            <!-- Nome com √≠cone e link para o pr√≥prio perfil -->
            <h2 class="text-2xl font-semibold text-gray-800 flex items-center">
                <i class="material-icons text-blue-500 mr-2">person</i>
                <a href="{% url 'app_associados:single_associado' associado.id %}" class="hover:underline hover:text-blue-600 transition">
                {{ associado.user.get_full_name }}
                </a>
            </h2>
  

                <!-- Associa√ß√£o e Reparti√ß√£o (Sem √≠cones, mantendo o padr√£o) -->
                <p class="mt-2 text-gray-700">
                    <i class="material-icons text-blue-500">apartment</i>
                    <strong>Associa√ß√£o:</strong> {{ associado.associacao.nome_fantasia }}</p>
                <p class="mt-2 text-gray-700">
                    <i class="material-icons text-blue-500">store_mall_directory</i>
                    <strong>Reparti√ß√£o:</strong> {{ associado.reparticao|default:"-" }}</p>
                <!-- Data de Filia√ß√£o -->
                <p class="mt-2 text-gray-700">
                    <i class="material-icons text-blue-400 mr-2">event</i>
                    <strong>Data de Filia√ß√£o:</strong> {{ associado.data_filiacao|date:"d/m/Y" }}
                </p>        

                <!-- Celular com bot√£o copiar -->
                <div class="flex items-center mt-3">
                    <i class="material-icons text-green-500 mr-2">phone</i>
                    <span id="celular-{{ associado.pk }}" class="text-gray-800"><strong>Celular: </strong>{{ associado.celular }}</span>
                    <button onclick="copyToClipboard('celular-{{ associado.pk }}')" class="ml-2 text-gray-600 hover:text-green-500">
                        <i class="material-icons text-sm">content_copy</i>
                    </button>
                </div>

                <!-- Resumo Financeiro (Discretamente destacado) -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-6">
                    <div class="bg-blue-50 p-4 rounded-md text-center shadow-sm">
                        <p class="text-sm font-semibold text-gray-600">Total de Anuidades</p>
                        <p class="text-lg font-bold text-blue-700">R$ {{ total_anuidades|floatformat:2 }}</p>
                    </div>

                    <div class="bg-green-50 p-4 rounded-md text-center shadow-sm">
                        <p class="text-sm font-semibold text-gray-600">Total Pago</p>
                        <p class="text-lg font-bold text-green-700">R$ {{ total_pago|floatformat:2 }}</p>
                    </div>

                    <div class="bg-red-50 p-4 rounded-md text-center shadow-sm">
                        <p class="text-sm font-semibold text-gray-600">Saldo Devedor</p>
                        <p class="text-lg font-bold {% if saldo_total > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                            R$ {{ saldo_total|floatformat:2 }}
                        </p>
                    </div>
                </div>
            </div>

            <!-- üîπ Bot√µes de A√ß√£o (Mais Delicados) -->
            <div class="flex space-x-2 justify-end">
                <!-- üîπ Bot√£o: Lista de Anuidades -->
                <a href="{% url 'app_finances:list_anuidades' %}" 
                    class="bg-gray-500 text-white px-3 py-1.5 text-sm rounded-md shadow hover:bg-gray-600 flex items-center">
                    <i class="material-icons text-base mr-1">list</i> Lista de Anuidades
                </a>
                
                <!-- üîπ Bot√£o: Lista Triangular -->
                <a href="{% url 'app_finances:tri_condictions' %}" 
                    class="bg-red-500 text-white px-3 py-1.5 text-sm rounded-md shadow hover:bg-red-600 flex items-center">
                    <i class="material-icons text-base mr-1">warning</i> Lista Triangular 
                </a>

            </div>

            <!-- Tabela de Anuidades -->
            <h2 class="text-xl font-semibold mb-4">Detalhes das Anuidades</h2>
            <p class="text-red-600 mb-4">Para dar baixa, use o ponto para separar os centavos <strong>( . )</strong> Ex: 25.00 </p>
            <table class="min-w-full border border-gray-300 rounded-md overflow-hidden shadow-md">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="px-4 py-2 text-left font-semibold text-gray-700">Ano</th>
                        <th class="px-4 py-2 text-center font-semibold text-gray-700">Valor Anuidade</th>
                        <th class="px-4 py-2 text-center font-semibold text-gray-700">Valor Pago</th>
                        <th class="px-4 py-2 text-center font-semibold text-yellow-600">Desconto</th>  <!-- ‚úÖ Nova coluna -->
                        <th class="px-4 py-2 text-center font-semibold text-gray-700">Saldo</th>
                        <th class="px-4 py-2 text-center font-semibold text-gray-700">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for anuidade in anuidades_associado %}
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-2 text-gray-800">{{ anuidade.ano }}</td>
                        <td class="px-4 py-2 text-center">R$ {{ anuidade.valor_total|floatformat:2 }}</td>
                        <td class="px-4 py-2 text-center text-blue-600 font-semibold">R$ {{ anuidade.valor_pago|floatformat:2 }}</td>
                        <td class="px-4 py-2 text-center text-yellow-600 font-semibold">
                            R$ {{ anuidade.valor_desconto|floatformat:2 }}  <!-- ‚úÖ Exibe o desconto -->
                        </td>
                        <td class="px-4 py-2 text-center">R$ {{ anuidade.saldo|floatformat:2 }}</td>
                        <td class="px-4 py-2 text-center">
                            {% if anuidade.saldo > 0 %}
                                <div class="flex flex-col gap-2">
                                    <!-- Formul√°rio de Dar Baixa -->
                                    <form method="post" action="{% url 'app_finances:dar_baixa_anuidade' anuidade.anuidade.id %}" class="flex items-center gap-2">
                                        {% csrf_token %}
                                        <input type="number" step="0.01" min="0.01" name="valor_baixa" class="w-24 p-1 border border-gray-300 rounded-md text-center" required>
                                        <button type="submit" class="bg-blue-500 text-white py-1 px-3 rounded hover:bg-blue-700">
                                            Dar Baixa
                                        </button>
                                    </form>
            
                                    <!-- Formul√°rio de Desconto -->
                                    <form method="post" action="{% url 'app_finances:conceder_desconto' anuidade.anuidade.id %}" class="flex items-center gap-2">
                                        {% csrf_token %}
                                        <input type="number" name="valor_desconto" step="0.01" min="0.01"
                                               class="w-24 p-1 border text-yellow-500 border-gray-300 rounded-md text-center" required
                                               placeholder="0.00">
                                        <input type="text" name="motivo"
                                               class="w-40 p-1 border text-yellow-600 border-gray-300 rounded-md"
                                               placeholder="Descri√ß√£o desconto" required>
                                        <button type="submit" class="bg-yellow-500 text-white py-1 px-3 rounded hover:bg-yellow-600">
                                            Aplicar Desconto
                                        </button>
                                    </form>
                                </div>
                            {% else %}
                            <div class="flex flex-col items-center gap-2">
                                <span class="text-green-600 font-semibold">Quitado</span>
                    
                                <a href="{% url 'app_automacoes:gerar_recibo_anuidade' anuidade.anuidade.id %}"
                                class="inline-block bg-green-500 text-white py-1 px-3 rounded hover:bg-green-700 text-sm transition">
                                üßæ Gerar Recibo
                                </a>
                           
                            </div>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            

            <!-- Acordeon para Relat√≥rio de Pagamentos -->
            <div class="mt-6">
                <button type="button" onclick="toggleAccordion()" class="w-full bg-gray-200 text-left px-4 py-3 font-semibold text-gray-700 hover:bg-gray-300 rounded-t-md focus:outline-none">
                    Relat√≥rio de Pagamentos
                </button>
                <div id="accordion-content" class="hidden bg-white p-6 border-t border-gray-300 rounded-b-md shadow-inner">
                    <table class="w-full border-collapse border border-gray-300 rounded-md">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="border px-4 py-2 text-left text-gray-700 font-semibold">Data</th>
                                <th class="border px-4 py-2 text-center text-gray-700 font-semibold">Valor</th>
                                <th class="border px-4 py-2 text-left text-gray-700 font-semibold">Ref. Anuidade</th>
                                <th class="border px-4 py-2 text-left text-gray-700 font-semibold">Registrado por</th>
                                <th class="border px-4 py-2 text-left text-gray-700 font-semibold">Descri√ß√£o Desconto</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for evento in eventos_financeiros %}
                            <tr class="border-b hover:bg-gray-50">
                                <td class="border px-4 py-2 text-gray-700">{{ evento.data|date:"d/m/Y" }}</td>
                    
                                {% if evento.tipo == "pagamento" %}
                                    <td class="border px-4 py-2 text-center text-blue-600 font-semibold">
                                        + R$ {{ evento.valor|floatformat:2 }}
                                    </td>
                                {% elif evento.tipo == "desconto" %}
                                    <td class="border px-4 py-2 text-center text-yellow-600 font-semibold">
                                        - R$ {{ evento.valor|floatformat:2 }} (Desconto)
                                    </td>
                                {% endif %}
                    
                                <td class="border px-4 py-2 text-gray-700">{{ evento.ano }}</td>
                                <td class="border px-4 py-2 text-gray-700">{{ evento.registrado_por.get_full_name|default:evento.registrado_por }}</td>
                                
                                <!-- Exibir motivo do desconto se existir -->
                                <td class="border px-4 py-2 text-gray-700">
                                    {% if evento.tipo == "desconto" %}
                                        <span class="italic text-yellow-700">{{ evento.motivo }}</span>
                                    {% else %}
                                        <span class="text-gray-500">‚Äî</span>  <!-- Para pagamentos, sem motivo -->
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="px-4 py-3 text-center text-gray-500 italic">Nenhum pagamento ou desconto registrado.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
<!-- Footer -->
{% include "components/footer_associacao.html" %}
<script src="{% static 'js/copy_to_clipboard.js' %}"></script>
<!-- Script para controle do acordeon -->
<script>
function toggleAccordion() {
    const content = document.getElementById('accordion-content');
    content.classList.toggle('hidden');
}
</script>


{% endblock financeiro_SingleAssociado %}
